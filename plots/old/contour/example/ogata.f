c======================================================================
c     integral form of the bessle function J0(z) and J1(z)
c======================================================================
      function bessel0(z) 
      IMPLICIT NONE
      REAL*8  zv,z,BESSEL0,qgauss,funb,pi,bdiv
      integer i,nbel,nbuu,nbut,nQ,nY
      common /zzz/ zv
      common /ngbesl/bdiv,nbel,nbuu,nbut,nQ,nY
      data pi /3.14159265359d0/
      external funb

      zv = z
      bessel0=qgauss(funb,0d0, pi,nbel)/pi
      return
      end

c---------------
      function bessel1(z) 
      IMPLICIT NONE
      REAL*8  zv,z,BESSEL1,qgauss,funb1,pi,bdiv
      integer i,nbel,nbuu,nbut,nQ,nY
      common /zzz/ zv
      common /ngbesl/bdiv,nbel,nbuu,nbut,nQ,nY
      data pi /3.14159265359d0/
      external funb1

      zv = z
      bessel1=qgauss(funb1,0d0, pi,nbel)/pi
      return
      end

c-------------------------------------------------------------------      
      function funb(theta)
      implicit none
      real*8 funb,zv,theta
      common/zzz/ zv
      funb=dcos(zv*dsin(theta))
      return
      end

c---------
      function funb1(theta)
      implicit none
      real*8 funb1,zv,theta
      common/zzz/ zv
      funb1=dcos(zv*dsin(theta)-theta)
      return
      end


cccccccccccccccccccccccccccccccccccccccccccccccccccccc
c   Auxiliary functions for ogata integration
cccccccccccccccccccccccccccccccccccccccccccccccccccccc
      function psi(t)
      real*8 t,psi
        psi=t*tanh(1.5707963267948966d0*sinh(t))
      end function

      function psip(t)
      real*8::psip,t,argum
        if(t>4d0) then ! Psi'(t) is basically 1 for t>4 or even less
           psip=1d0
        else    ! For smaller values we proeprly define it
           argum=3.141592653589793d0*sinh(t)
           psip=(3.141592653589793d0*t*cosh(t)+sinh(argum))
     >          /(1d0+cosh(argum))
        end if
      end function
cccccccccccccccccccccccccccccccccccccccccccccccccccccc

c-----------------------------------------------------------------------
c Integrands for bessel functions
c-----------------------------------------------------------------------
      real(kind=8) function funb_og(theta,z)
      implicit none
      real*8, intent(in) :: theta
      real*8 z
      
      funb_og=dcos(z*dsin(theta))
      return
      end function

      real(kind=8) function funb1_og(theta,z)
      implicit none
      real*8 z,theta
      funb1_og=dcos(z*dsin(theta)-theta)
      return
      end function
      
c-----------------------------------------------------------------------
c Numerical gaussian quadrature
c-----------------------------------------------------------------------
      real(kind=8) function qgauss_og(func,xi,xf,n,z)
      implicit none
      real*8 func,xi,xf,xn,value,x1,x2,z,val
      integer i,n
      external func

      if(n.le.1) then           ! same as n=1
         x1=xi
         x2=xf
         call gauss_og(func,x1,x2,z,val)
         qgauss_og=val
         return
      endif
    
      xn=(xf-xi)/float(n)
      value=0d0
      x2=xi
      Do 100 i=1,n
         x1=x2
         x2=x1+xn
         call gauss_og(func,x1,x2,z,val)
         value=value+val
 100  continue

      qgauss_og=value
      return
      end function

      subroutine gauss_og(func,xi,xf,z,value)
      implicit none
      real*8 func,xi,xf,value,xm,xr,dx,x(8),w(8)
      real*8 eps,z
      integer j
      data eps /1.0d-25/
      data w
     1   / 0.02715 24594 11754 09485 17805 725D0,
     2     0.06225 35239 38647 89286 28438 370D0,
     3     0.09515 85116 82492 78480 99251 076D0,
     4     0.12462 89712 55533 87205 24762 822D0,
     5     0.14959 59888 16576 73208 15017 305D0,
     6     0.16915 65193 95002 53818 93120 790D0,
     7     0.18260 34150 44923 58886 67636 680D0,
     8     0.18945 06104 55068 49628 53967 232D0 /
      DATA X
     1   / 0.98940 09349 91649 93259 61541 735D0,
     2     0.94457 50230 73232 57607 79884 155D0,
     3     0.86563 12023 87831 74388 04678 977D0,
     4     0.75540 44083 55003 03389 51011 948D0,
     5     0.61787 62444 02643 74844 66717 640D0,
     6     0.45801 67776 57227 38634 24194 430D0,
     7     0.28160 35507 79258 91323 04605 015D0,
     8     0.09501 25098 37637 44018 53193 354D0 /
      
      xm=0.5d0*(xf+xi)
      xr=0.5d0*(xf-xi)
      if (abs(xr).lt.eps) print *,
     >     'WARNING: Too high accuracy required for QGAUSS!'
 
      value=0d0

      Do 100 j=1,8
         dx=xr*x(j)
         value=value+w(j)*(func(xm+dx,z)+func(xm-dx,z))
 100  continue
	
      value=xr*value
      return
      end subroutine
c-----------------------------------------------------------------------
c Bessel function J0,J1
c-----------------------------------------------------------------------
      real(kind=8) function bessel0_og(z) 
      IMPLICIT NONE
      real*8, intent(in) :: z
      real(kind=8) pi
      integer nbel
      real*8, external :: funb_og,qgauss_og
      
      nbel=20
      pi = 3.14159265359d0

      bessel0_og=qgauss_og(funb_og,0d0, pi,nbel,z)/pi
      return
      end function

      real(kind=8) function bessel1_og(z) 
      IMPLICIT NONE
      real(kind=8), intent(in) :: z
      REAL*8  pi
      integer nbel
      real*8, external :: funb1_og,qgauss_og
      
      nbel=20
      pi = 3.14159265359d0
      
      bessel1_og=qgauss_og(funb1_og,0d0, pi,nbel,z)/pi
      return
      end function

c-----------------------------------------------------------------------
c Newton's numerical method
c-----------------------------------------------------------------------      
      subroutine solve(f, fp, x0, bval, qT, dum, x, iters, debug,nu)
          implicit none
          real(kind=8), intent(in) :: x0,bval,qT,dum
          integer, intent(in) :: nu
          real(kind=8), external :: f, fp
          logical, intent(in) :: debug
          real(kind=8), intent(out) :: x
          integer, intent(out) :: iters

          ! Declare any local variables:
          real(kind=8) :: deltax, fx, fxprime,tol
          integer :: k,maxiter
          
          maxiter = 20
          tol = 1.d-14

            ! initial guess
          x = x0

          if (debug) then
              !print 11, x
        ! 11   format('Initial guess: x = ', e22.15)
              endif

            ! Newton iteration to find a zero of f(x) 

          do k=1,maxiter

              ! evaluate function and its derivative:
              fx = f(bval,qT,dum,x,nu)
              fxprime = fp(qT,dum,x,nu)
              if (abs(fx) < tol) then
                  exit  ! jump out of do loop
                  endif

              ! compute Newton increment x:
              deltax = fx/fxprime

              ! update x:
              x = x - deltax

              if (debug) then
                    !print 12, k,x
         !12       format('After', i3, ' iterations, x = ', e22.15)
                  endif

              enddo


          if (k > maxiter) then
                ! might not have converged

              fx = f(bval,qT,dum,x,nu)
              if (abs(fx) > tol) then
                    !print *, '*** Warning: has not yet converged'
                  endif
              endif 

            ! number of iterations taken:
          iters = k-1


      end subroutine solve

      real(kind=8) function func_min(bmin,qT,dum,h,nu)
          implicit none
          real(kind=8), intent(in) :: bmin,qT,dum,h
          integer, intent(in) :: nu
          real(kind=8) J0,pi
          
      !dum is dummy variable used to hold place
          
          if (nu .eq. 0) then
             J0 = 2.404825557695773d0
          else if (nu .eq. 1) then
             J0 = 3.81705979297512d0
          end if
          pi = 3.141592653589793d0
        
          func_min= bmin-J0/qT*dtanh(pi/2d0*dsinh(h*J0/pi))
  
      end function func_min

      real(kind=8) function func_prime_h(qT,dum,h,nu)
          implicit none
          real(kind=8), intent(in) :: qT,dum,h
          integer, intent(in) :: nu
          real(kind=8) J0,pi
      
      !dum is dummy variable used to hold place
        
          if (nu .eq. 0) then
             J0 = 2.404825557695773d0
          else if (nu .eq. 1) then
             J0 = 3.831705970207512d0
          end if

          pi = 3.141592653589793d0
        
          func_prime_h = -J0**2d0/2d0/qT*dcosh(h*J0/pi)*
     >    (dcosh(pi/2d0*dsinh(h*J0/pi)))**(-2d0)

      end function func_prime_h

      real(kind=8) function func_max(bmax,qT,h,n,nu)
          implicit none
          real(kind=8), intent(in) :: bmax,qT,h,n
          real(kind=8) J0,pi
          integer, intent(in) :: nu
        
          if (nu .eq. 0) then
             J0 = 2.404825557695773d0
          else if (nu .eq. 1) then
             J0 = 3.831705970207512d0
          end if

          pi = 3.141592653589793d0
        
          func_max = bmax-pi*n/qT*dtanh(pi/2d0*dsinh(h*n))
  
      end function func_max
      
      real(kind=8) function func_prime_n(qT,h,n,nu)
          implicit none
          real(kind=8), intent(in) :: qT,h,n
          integer, intent(in) :: nu
          real(kind=8) J0,pi
        
          if (nu .eq. 0) then
             J0 = 2.404825557695773d0
          else if (nu .eq. 1) then
             J0 = 3.831705970207512d0
          end if

          pi = 3.141592653589793d0
          
          func_prime_n=-h*n*pi**2/2d0/qT*dcosh(h*n)*
     >    (dcosh(pi/2d0*dsinh(h*n)))**(-2d0)
     >    -pi/qT*dtanh(pi/2d0*dsinh(h*n))
      
      end function func_prime_n
c-----------------------------------------------------------------------
c Determines range of b values
c-----------------------------------------------------------------------
      subroutine get_b_vals(func,Q,eps,ccut,bn,bx)
      implicit none
      real*8, intent(in) :: Q,eps,ccut
      real*8, intent(out) :: bn,bx
      real(kind=8) , external :: func
      real*8 peakval,bot,top,bc
      integer ib,it
      
      ib=1
      it=1
      bc=2d0/Q
      peakval=func(bc)
      bot = func(bc/ccut**ib)
      top = func(bc*ccut**it)
      do while (eps*peakval .lt. top)
         if (top .gt. peakval) then
            peakval = top
         end if
         it=it+1
         top = func(bc*ccut**it)
      end do
      do while (eps*peakval .lt. bot)
        if (bot .gt. peakval) then
          peakval = bot
        end if
        ib=ib+1
        bot = func(bc/ccut**ib)
      end do
      bn = bc/((ccut)**ib)
      bx = bc*ccut**it
      return
      end subroutine get_b_vals
c-----------------------------------------------------------------------
c Determine ogata parameters h,n
c-----------------------------------------------------------------------
      subroutine get_ogata_params(bx,bn,qT,nu,h,n)
      implicit none
      real*8, intent(in) :: bx, bn, qT
      integer, intent(in) :: nu
      real*8, intent(out) :: h,n
      real*8 h0,n0,J0,pi,dum,func_min,func_prime_h,func_max,func_prime_n
      integer :: iters, itest
      logical :: debug 
      external func_min,func_prime_h,func_max,func_prime_n
      
      if (nu .eq. 0) then
         J0 = 2.404825557695773d0
      else if (nu .eq. 1) then
         J0 = 3.831705970207512d0
      end if
      pi = 3.141592653589793d0
      h0 = 2d0*bn*qT/J0**2
      n0 = 2d0*bx*qT/pi
      dum=1.0d0
      debug=.true.
      
      call solve(func_min,func_prime_h,h0,bn,qT,dum,h,iters,debug,nu)
      call solve(func_max,func_prime_n,n0,bx,qT,h,n,iters,debug,nu)
      return
      end subroutine get_ogata_params
c-----------------------------------------------------------------------
c Inversions for nu=0,1
c-----------------------------------------------------------------------
      subroutine ogataJ0(func,h,N,qT,z,res)
      implicit none
      real*8, intent(in) :: h,N,qT,z
      real*8, intent(out) :: res
      real(kind=8), external :: func
      real*8 pi,knots,Jnu,xi,psi,psip,bessel0_og
      real*8 J0zeros(199),w(199)
      integer j
      external psi,psip,bessel0_og
      real*8 start,finish,elapsed
      
      pi = 3.141592653589793d0
c	zeros of the besselJ0 function
      data J0zeros / 2.404825557695773,
     >               5.520078110286311,
     >               8.65372791291101,
     >               11.79153443901428,
     >               14.93091770848779,
     >               18.07106396791092,
     >               21.21163662987926,
     >               24.3524715307493,
     >               27.49347913204025,
     >               30.63460646843198,
     >               33.77582021357357,
     >               36.91709835366404,
     >               40.05842576462824,
     >               43.19979171317673,
     >               46.34118837166182,
     >               49.48260989739781,
     >               52.624051841115,
     >               55.76551075501998,
     >               58.90698392608094,
     >               62.04846919022716,
     >               65.18996480020687,
     >               68.3314693298568,
     >               71.47298160359374,
     >               74.61450064370183,
     >               77.75602563038805,
     >               80.8975558711376,
     >               84.0390907769382,
     >               87.1806298436412,
     >               90.3221726372105,
     >               93.4637187819448,
     >               96.6052679509963,
     >               99.7468198586806,
     >               102.8883742541948,
     >               106.0299309164516,
     >               109.1714896498054,
     >               112.3130502804949,
     >               115.4546126536669,
     >               118.5961766308725,
     >               121.737742087951,
     >               124.879308913233,
     >               128.0208770060083,
     >               131.1624462752139,
     >               134.3040166383055,
     >               137.4455880202843,
     >               140.5871603528543,
     >               143.7287335736897,
     >               146.8703076257966,
     >               150.0118824569548,
     >               153.1534580192279,
     >               156.2950342685335,
     >               159.4366111642632,
     >               162.5781886689467,
     >               165.719766747955,
     >               168.8613453692358,
     >               172.0029245030782,
     >               175.1445041219027,
     >               178.2860842000738,
     >               181.427664713731,
     >               184.5692456406387,
     >               187.7108269600494,
     >               190.8524086525815,
     >               193.9939907001091,
     >               197.1355730856614,
     >               200.2771557933324,
     >               203.4187388081986,
     >               206.5603221162445,
     >               209.7019057042941,
     >               212.8434895599495,
     >               215.985073671534,
     >               219.1266580280406,
     >               222.2682426190843,
     >               225.4098274348594,
     >               228.5514124660988,
     >               231.6929977040386,
     >               234.8345831403832,
     >               237.9761687672757,
     >               241.117754577268,
     >               244.2593405632957,
     >               247.4009267186528,
     >               250.5425130369699,
     >               253.6840995121931,
     >               256.8256861385644,
     >               259.9672729106045,
     >               263.1088598230955,
     >               266.2504468710659,
     >               269.392034049776,
     >               272.5336213547049,
     >               275.6752087815374,
     >               278.8167963261531,
     >               281.9583839846149,
     >               285.0999717531595,
     >               288.2415596281877,
     >               291.3831476062552,
     >               294.524735684065,
     >               297.666323858459,
     >               300.8079121264111,
     >               303.9495004850206,
     >               307.091088931505,
     >               310.232677463195,
     >               313.3742660775279,
     >               316.5158547720429,
     >               319.6574435443762,
     >               322.7990323922556,
     >               325.9406213134967,
     >               329.0822103059985,
     >               332.2237993677396,
     >               335.3653884967741,
     >               338.5069776912284,
     >               341.6485669492981,
     >               344.790156269244,
     >               347.9317456493902,
     >               351.0733350881206,
     >               354.2149245838765,
     >               357.3565141351538,
     >               360.498103740501,
     >               363.639693398517,
     >               366.7812831078483,
     >               369.9228728671875,
     >               373.0644626752713,
     >               376.2060525308784,
     >               379.3476424328285,
     >               382.4892323799793,
     >               385.6308223712264,
     >               388.7724124055006,
     >               391.9140024817674,
     >               395.0555925990249,
     >               398.1971827563028,
     >               401.3387729526615,
     >               404.4803631871904,
     >               407.6219534590068,
     >               410.7635437672553,
     >               413.9051341111063,
     >               417.0467244897553,
     >               420.1883149024217,
     >               423.329905348348,
     >               426.4714958267996,
     >               429.6130863370627,
     >               432.7546768784446,
     >               435.8962674502723,
     >               439.0378580518925,
     >               442.17944868267,
     >               445.3210393419877,
     >               448.462630029246,
     >               451.6042207438617,
     >               454.7458114852677,
     >               457.8874022529128,
     >               461.0289930462605,
     >               464.1705838647888,
     >               467.3121747079899,
     >               470.4537655753699,
     >               473.5953564664472,
     >               476.7369473807533,
     >               479.8785383178322,
     >               483.0201292772397,
     >               486.1617202585427,
     >               489.3033112613194,
     >               492.444902285159,
     >               495.5864933296608,
     >               498.7280843944346,
     >               501.8696754790994,
     >               505.0112665832841,
     >               508.1528577066267,
     >               511.294448848774,
     >               514.4360400093816,
     >               517.5776311881132,
     >               520.719222384641,
     >               523.8608135986445,
     >               527.0024048298116,
     >               530.1439960778367,
     >               533.285587342422,
     >               536.427178623277,
     >               539.5687699201169,
     >               542.7103612326645,
     >               545.8519525606484,
     >               548.9935439038036,
     >               552.1351352618713,
     >               555.2767266345982,
     >               558.4183180217369,
     >               561.5599094230457,
     >               564.701500838288,
     >               567.8430922672325,
     >               570.984683709653,
     >               574.1262751653285,
     >               577.2678666340424,
     >               580.409458115583,
     >               583.5510496097433,
     >               586.6926411163202,
     >               589.8342326351157,
     >               592.9758241659354,
     >               596.1174157085893,
     >               599.2590072628912,
     >               602.4005988286588,
     >               605.5421904057138,
     >               608.6837819938813,
     >               611.8253735929903,
     >               614.9669652028729,
     >               618.108556823365,
     >               621.2501484543054,
     >               624.3917400955367
     >             /

c	Ogata weights for J0: w_k= Y0(J0zeros(k))/J1(J0zeros(k))
      data w /      0.982234116721851,
     >               0.996095171243873,
     >               0.998366122082433,
     >               0.999111510480703,
     >               0.999443441245323,
     >               0.999619173282118,
     >               0.99972321137355,
     >               0.999789817248312,
     >               0.999834998997102,
     >               0.999867043958289,
     >               0.99989058969641,
     >               0.999908395066569,
     >               0.999922184380254,
     >               0.999933080156475,
     >               0.999941838566334,
     >               0.999948984043077,
     >               0.999954889543911,
     >               0.999959826163456,
     >               0.999963994777157,
     >               0.999967546784798,
     >               0.999970598042517,
     >               0.999973238424263,
     >               0.99997553851202,
     >               0.999977554359423,
     >               0.999979330937626,
     >               0.999980904664115,
     >               0.999982305283114,
     >               0.999983557280843,
     >               0.999984680962619,
     >               0.999985693281078,
     >               0.99998660847913,
     >               0.999987438593534,
     >               0.999988193852591,
     >               0.999988882992648,
     >               0.999989513511808,
     >               0.999990091874711,
     >               0.999990623678855,
     >               0.999991113790522,
     >               0.999991566456462,
     >               0.999991985396193,
     >               0.999992373878634,
     >               0.999992734786055,
     >               0.999993070667681,
     >               0.999993383784832,
     >               0.999993676149075,
     >               0.9999939495546,
     >               0.999994205605822,
     >               0.999994445740961,
     >               0.999994671252277,
     >               0.999994883303502,
     >               0.999995082944868,
     >               0.999995271126144,
     >               0.999995448707946,
     >               0.999995616471599,
     >               0.999995775127738,
     >               0.999995925323851,
     >               0.999996067650893,
     >               0.999996202649105,
     >               0.999996330813154,
     >               0.999996452596662,
     >               0.999996568416235,
     >               0.999996678655019,
     >               0.999996783665882,
     >               0.999996883774239,
     >               0.99999697928057,
     >               0.999997070462687,
     >               0.999997157577747,
     >               0.999997240864074,
     >               0.999997320542786,
     >               0.999997396819268,
     >               0.999997469884493,
     >               0.999997539916221,
     >               0.999997607080081,
     >               0.999997671530547,
     >               0.999997733411836,
     >               0.999997792858705,
     >               0.999997849997193,
     >               0.999997904945284,
     >               0.999997957813523,
     >               0.999998008705565,
     >               0.999998057718689,
     >               0.999998104944259,
     >               0.999998150468157,
     >               0.999998194371164,
     >               0.999998236729325,
     >               0.99999827761428,
     >               0.99999831709356,
     >               0.999998355230872,
     >               0.999998392086355,
     >               0.999998427716816,
     >               0.99999846217595,
     >               0.999998495514541,
     >               0.999998527780652,
     >               0.999998559019795,
     >               0.999998589275093,
     >               0.99999861858743,
     >               0.999998646995588,
     >               0.999998674536377,
     >               0.999998701244749,
     >               0.999998727153916,
     >               0.999998752295449,
     >               0.999998776699376,
     >               0.99999880039427,
     >               0.999998823407334,
     >               0.999998845764481,
     >               0.9999988674904,
     >               0.999998888608633,
     >               0.999998909141633,
     >               0.999998929110827,
     >               0.999998948536668,
     >               0.999998967438692,
     >               0.999998985835563,
     >               0.999999003745123,
     >               0.999999021184432,
     >               0.99999903816981,
     >               0.999999054716875,
     >               0.999999070840579,
     >               0.999999086555244,
     >               0.999999101874587,
     >               0.999999116811759,
     >               0.999999131379367,
     >               0.999999145589501,
     >               0.999999159453764,
     >               0.999999172983289,
     >               0.999999186188766,
     >               0.999999199080461,
     >               0.999999211668238,
     >               0.999999223961574,
     >               0.999999235969583,
     >               0.999999247701024,
     >               0.999999259164329,
     >               0.999999270367605,
     >               0.999999281318658,
     >               0.999999292025003,
     >               0.999999302493877,
     >               0.999999312732251,
     >               0.999999322746842,
     >               0.999999332544126,
     >               0.999999342130344,
     >               0.999999351511514,
     >               0.999999360693445,
     >               0.999999369681739,
     >               0.999999378481801,
     >               0.999999387098852,
     >               0.99999939553793,
     >               0.999999403803905,
     >               0.999999411901477,
     >               0.99999941983519,
     >               0.999999427609436,
     >               0.99999943522846,
     >               0.999999442696367,
     >               0.999999450017126,
     >               0.99999945719458,
     >               0.999999464232442,
     >               0.999999471134311,
     >               0.999999477903667,
     >               0.999999484543882,
     >               0.999999491058218,
     >               0.999999497449839,
     >               0.999999503721806,
     >               0.999999509877088,
     >               0.999999515918562,
     >               0.999999521849015,
     >               0.999999527671153,
     >               0.999999533387595,
     >               0.999999539000887,
     >               0.999999544513493,
     >               0.999999549927809,
     >               0.999999555246156,
     >               0.999999560470789,
     >               0.999999565603899,
     >               0.999999570647609,
     >               0.999999575603984,
     >               0.999999580475028,
     >               0.99999958526269,
     >               0.999999589968861,
     >               0.99999959459538,
     >               0.999999599144035,
     >               0.999999603616564,
     >               0.999999608014655,
     >               0.999999612339951,
     >               0.999999616594051,
     >               0.999999620778507,
     >               0.999999624894833,
     >               0.999999628944498,
     >               0.999999632928935,
     >               0.999999636849537,
     >               0.999999640707661,
     >               0.999999644504626,
     >               0.999999648241719,
     >               0.999999651920192,
     >               0.999999655541264,
     >               0.999999659106124,
     >               0.999999662615929,
     >               0.999999666071807,
     >               0.999999669474858,
     >               0.999999672826151,
     >               0.999999676126732,
     >               0.999999679377619/

      res=0d0
      if (int(N).gt.size(J0zeros)) then
        print *, 'N exceeds zeros'
      else
        do j = 1,int(N)
          xi=J0zeros(j)/pi
          knots = pi/h*psi(h*xi)
          Jnu=bessel0_og(knots)
          res = res + 1d0/2d0*func(knots/qT*z)/qT*z*w(j)*Jnu*psip(h*xi)
          !print *, func(knots/qT*z)
        end do
      end if
c------------------------------------------------------------
c      call cpu_time(start)
c      do j = 1,int(N)
c      xi=J0zeros(j)/pi
c      knots = pi/h*psi(h*xi)
c      res = func(knots/qT*z)
c      end do
c      call cpu_time(finish)
c      elapsed = finish-start
c      print *, 'elasped time 4 is', elapsed/60d0, 'mins'
c-------------------------------------------------------------
      return
      end subroutine ogataJ0
      
      subroutine ogataJ1(func,h,N,qT,z,res)
      implicit none
      real*8, intent(in) :: h,N,qT,z
      real*8, intent(out) :: res
      real(kind=8) , external :: func,psi,psip,bessel1_og
      real*8 pi,knots,Jnu,xi
      real*8 J1zeros(199),w(199)
      integer j
      
      pi = 3.141592653589793d0
c	zeros of the besselJ1 function
      data J1zeros / 3.831705970207512,
     >               7.0155866698156,
     >               10.17346813506272,
     >               13.32369193631422,
     >               16.47063005087763,
     >               19.61585851046824,
     >               22.76008438059277,
     >               25.90367208761838,
     >               29.04682853491686,
     >               32.18967991097441,
     >               35.33230755008387,
     >               38.47476623477161,
     >               41.61709421281445,
     >               44.75931899765282,
     >               47.90146088718545,
     >               51.04353518357151,
     >               54.18555364106131,
     >               57.32752543790101,
     >               60.46945784534749,
     >               63.61135669848123,
     >               66.75322673409849,
     >               69.89507183749578,
     >               73.03689522557383,
     >               76.17869958464146,
     >               79.3204871754763,
     >               82.4622599143736,
     >               85.6040194363502,
     >               88.7457671449263,
     >               91.887504251695,
     >               95.0292318080447,
     >               98.1709507307908,
     >               101.3126618230387,
     >               104.4543657912828,
     >               107.5960632595092,
     >               110.7377547808992,
     >               113.879440847595,
     >               117.0211218988924,
     >               120.162798328149,
     >               123.3044704886357,
     >               126.4461386985166,
     >               129.587803245104,
     >               132.7294643885096,
     >               135.871122364789,
     >               139.0127773886597,
     >               142.154429655859,
     >               145.2960793451959,
     >               148.4377266203422,
     >               151.5793716314014,
     >               154.7210145162859,
     >               157.8626554019303,
     >               161.004294405362,
     >               164.1459316346496,
     >               167.2875671897441,
     >               170.4292011632266,
     >               173.5708336409759,
     >               176.7124647027638,
     >               179.8540944227884,
     >               182.995722870153,
     >               186.1373501092955,
     >               189.278976200376,
     >               192.4206011996257,
     >               195.5622251596626,
     >               198.703848129777,
     >               201.8454701561909,
     >               204.9870912822923,
     >               208.1287115488501,
     >               211.2703309942078,
     >               214.411949654462,
     >               217.5535675636242,
     >               220.6951847537693,
     >               223.8368012551717,
     >               226.9784170964295,
     >               230.1200323045791,
     >               233.2616469052006,
     >               236.4032609225143,
     >               239.5448743794699,
     >               242.6864872978287,
     >               245.8280996982398,
     >               248.9697116003099,
     >               252.1113230226686,
     >               255.2529339830282,
     >               258.3945444982395,
     >               261.5361545843441,
     >               264.6777642566215,
     >               267.8193735296346,
     >               270.9609824172707,
     >               274.1025909327807,
     >               277.2441990888146,
     >               280.3858068974556,
     >               283.5274143702514,
     >               286.6690215182434,
     >               289.8106283519944,
     >               292.9522348816139,
     >               296.0938411167825,
     >               299.2354470667741,
     >               302.3770527404775,
     >               305.5186581464156,
     >               308.6602632927644,
     >               311.8018681873705,
     >               314.9434728377671,
     >               318.0850772511904,
     >               321.2266814345928,
     >               324.3682853946579,
     >               327.5098891378125,
     >               330.6514926702394,
     >               333.7930959978885,
     >               336.934699126488,
     >               340.0763020615541,
     >               343.2179048084012,
     >               346.359507372151,
     >               349.5011097577409,
     >               352.6427119699324,
     >               355.7843140133188,
     >               358.9259158923327,
     >               362.0675176112526,
     >               365.2091191742101,
     >               368.3507205851957,
     >               371.4923218480648,
     >               374.6339229665437,
     >               377.7755239442347,
     >               380.9171247846209,
     >               384.0587254910721,
     >               387.2003260668483,
     >               390.3419265151044,
     >               393.483526838895,
     >               396.6251270411776,
     >               399.7667271248168,
     >               402.9083270925879,
     >               406.0499269471803,
     >               409.1915266912009,
     >               412.333126327177,
     >               415.4747258575594,
     >               418.6163252847256,
     >               421.7579246109818,
     >               424.8995238385667,
     >               428.0411229696527,
     >               431.1827220063489,
     >               434.3243209507038,
     >               437.4659198047066,
     >               440.6075185702901,
     >               443.7491172493322,
     >               446.890715843658,
     >               450.0323143550416,
     >               453.1739127852082,
     >               456.3155111358349,
     >               459.4571094085536,
     >               462.5987076049514,
     >               465.7403057265727,
     >               468.8819037749206,
     >               472.0235017514582,
     >               475.1650996576098,
     >               478.3066974947622,
     >               481.4482952642662,
     >               484.5898929674376,
     >               487.731490605558,
     >               490.8730881798765,
     >               494.0146856916103,
     >               497.1562831419456,
     >               500.2978805320394,
     >               503.4394778630194,
     >               506.5810751359852,
     >               509.7226723520096,
     >               512.8642695121389,
     >               516.0058666173942,
     >               519.1474636687714,
     >               522.2890606672431,
     >               525.4306576137581,
     >               528.5722545092428,
     >               531.7138513546017,
     >               534.8554481507182,
     >               537.9970448984547,
     >               541.1386415986541,
     >               544.2802382521394,
     >               547.4218348597149,
     >               550.5634314221664,
     >               553.7050279402621,
     >               556.8466244147527,
     >               559.9882208463721,
     >               563.1298172358377,
     >               566.2714135838511,
     >               569.4130098910987,
     >               572.5546061582511,
     >               575.6962023859651,
     >               578.8377985748825,
     >               581.9793947256318,
     >               585.1209908388276,
     >               588.2625869150719,
     >               591.4041829549533,
     >               594.5457789590482,
     >               597.6873749279211,
     >               600.8289708621243,
     >               603.9705667621989,
     >               607.1121626286747,
     >               610.2537584620707,
     >               613.395354262895,
     >               616.5369500316456,
     >               619.6785457688103,
     >               622.8201414748671,
     >               625.9617371502843/

c	Ogata weights for J1: w_k= Y1(J1zeros(k))/J2(J1zeros(k))
      data w /      1.024227862988153,
     >               1.007484900740164,
     >               1.003591661601998,
     >               1.00210153401312,
     >               1.001377624501809,
     >               1.000972229884043,
     >               1.000722609013145,
     >               1.00055809135955,
     >               1.000443969837702,
     >               1.000361581733231,
     >               1.000300166437122,
     >               1.000253165757646,
     >               1.000216397983523,
     >               1.000187094702657,
     >               1.000163364094007,
     >               1.000143877784342,
     >               1.000127680845352,
     >               1.000114072546103,
     >               1.000102529275468,
     >               1.000092653414259,
     >               1.00008413863245,
     >               1.000076745846616,
     >               1.000070286252988,
     >               1.000064609152694,
     >               1.000059593082468,
     >               1.000055139263616,
     >               1.000051166701738,
     >               1.00004760847837,
     >               1.000044408914385,
     >               1.000041521378558,
     >               1.000038906578912,
     >               1.000036531218989,
     >               1.000034366932616,
     >               1.000032389433129,
     >               1.000030577829061,
     >               1.000028914070107,
     >               1.000027382495762,
     >               1.000025969465459,
     >               1.000024663053802,
     >               1.000023452798128,
     >               1.000022329488376,
     >               1.00002128499135,
     >               1.000020312103082,
     >               1.000019404424289,
     >               1.000018556254875,
     >               1.000017762504217,
     >               1.000017018614614,
     >               1.000016320495705,
     >               1.00001566446813,
     >               1.000015047214946,
     >               1.000014465739621,
     >               1.000013917329595,
     >               1.000013399524593,
     >               1.000012910088977,
     >               1.000012446987581,
     >               1.000012008364517,
     >               1.00001159252455,
     >               1.0000111979167,
     >               1.000010823119756,
     >               1.000010466829458,
     >               1.000010127847142,
     >               1.00000980506964,
     >               1.000009497480294,
     >               1.000009204140945,
     >               1.000008924184763,
     >               1.000008656809847,
     >               1.000008401273464,
     >               1.000008156886894,
     >               1.000007923010783,
     >               1.000007699050954,
     >               1.000007484454633,
     >               1.000007278707033,
     >               1.000007081328264,
     >               1.000006891870531,
     >               1.000006709915595,
     >               1.000006535072464,
     >               1.000006366975284,
     >               1.000006205281428,
     >               1.00000604966975,
     >               1.000005899838986,
     >               1.000005755506299,
     >               1.000005616405937,
     >               1.000005482288016,
     >               1.000005352917391,
     >               1.000005228072626,
     >               1.000005107545051,
     >               1.000004991137881,
     >               1.000004878665419,
     >               1.000004769952313,
     >               1.000004664832868,
     >               1.000004563150422,
     >               1.000004464756758,
     >               1.00000436951156,
     >               1.00000427728192,
     >               1.000004187941865,
     >               1.000004101371937,
     >               1.000004017458786,
     >               1.000003936094799,
     >               1.00000385717776,
     >               1.000003780610524,
     >               1.000003706300719,
     >               1.000003634160469,
     >               1.000003564106131,
     >               1.000003496058056,
     >               1.000003429940361,
     >               1.000003365680714,
     >               1.000003303210143,
     >               1.000003242462845,
     >               1.000003183376016,
     >               1.000003125889685,
     >               1.000003069946567,
     >               1.000003015491914,
     >               1.000002962473388,
     >               1.000002910840929,
     >               1.00000286054664,
     >               1.000002811544675,
     >               1.000002763791135,
     >               1.000002717243969,
     >               1.000002671862882,
     >               1.000002627609248,
     >               1.000002584446025,
     >               1.000002542337683,
     >               1.000002501250125,
     >               1.000002461150621,
     >               1.000002422007743,
     >               1.000002383791304,
     >               1.000002346472295,
     >               1.000002310022836,
     >               1.00000227441612,
     >               1.000002239626369,
     >               1.000002205628777,
     >               1.000002172399475,
     >               1.000002139915489,
     >               1.000002108154694,
     >               1.000002077095782,
     >               1.000002046718222,
     >               1.000002017002229,
     >               1.000001987928732,
     >               1.000001959479341,
     >               1.000001931636321,
     >               1.00000190438256,
     >               1.000001877701548,
     >               1.000001851577348,
     >               1.000001825994572,
     >               1.000001800938362,
     >               1.000001776394366,
     >               1.000001752348717,
     >               1.000001728788014,
     >               1.000001705699304,
     >               1.000001683070064,
     >               1.000001660888182,
     >               1.000001639141944,
     >               1.000001617820017,
     >               1.000001596911433,
     >               1.000001576405576,
     >               1.00000155629217,
     >               1.000001536561263,
     >               1.000001517203219,
     >               1.000001498208701,
     >               1.000001479568664,
     >               1.000001461274341,
     >               1.000001443317236,
     >               1.000001425689112,
     >               1.000001408381981,
     >               1.000001391388098,
     >               1.000001374699947,
     >               1.000001358310239,
     >               1.000001342211901,
     >               1.000001326398065,
     >               1.000001310862068,
     >               1.000001295597438,
     >               1.000001280597893,
     >               1.00000126585733,
     >               1.000001251369821,
     >               1.000001237129607,
     >               1.00000122313109,
     >               1.000001209368833,
     >               1.000001195837548,
     >               1.000001182532096,
     >               1.000001169447478,
     >               1.000001156578835,
     >               1.00000114392144,
     >               1.000001131470695,
     >               1.000001119222123,
     >               1.000001107171374,
     >               1.000001095314209,
     >               1.000001083646504,
     >               1.000001072164244,
     >               1.00000106086352,
     >               1.000001049740525,
     >               1.000001038791552,
     >               1.00000102801299,
     >               1.000001017401319,
     >               1.000001006953112,
     >               1.000000996665031,
     >               1.000000986533818,
     >               1.000000976556301,
     >               1.000000966729387,
     >               1.000000957050059 /

      res=0d0
      if (int(N).gt.size(J1zeros)) then
        print *, N, 'N exceeds zeros'
      else
        do j = 1,int(N)
          xi=J1zeros(j)/pi
          knots = pi/h*psi(h*xi)
          Jnu=bessel1_og(knots)
          res = res + 1d0/2d0*func(knots/qT*z)/qT*z*w(j)*Jnu*psip(h*xi)
          !print *, func(knots/qT*z)
        end do
      end if
      return
      end subroutine ogataJ1
c-----------------------------------------------------------------------
c Adaptive ogata 1/{2\pi}\int_0^{\infty} db b J_{\nu}(qT b) func(b)
c-----------------------------------------------------------------------
      subroutine adog(func,qT,Q,nu,z,res)
      implicit none
      real*8, intent(in) :: qT,Q,z
      integer, intent(in) :: nu
      real(kind=8), external :: func
      real(kind=8), intent(out) :: res
      real*8 pi,bn,bx,n,h,eps,ccut
      
      pi=3.141592653589793d0
      eps=0.05d0
      ccut=2d0
      
      call get_b_vals(func,Q,eps,ccut,bn,bx)
      call get_ogata_params(bx,bn,qT/z,nu,h,n)
      if (nu.eq.0) then 
        call ogataJ0(func,h,n,qT,z,res)
      else if (nu.eq.1) then
        call ogataJ1(func,h,n,qT,z,res)
      end if
      return
      end subroutine adog

c-----------------------------------------------------------------------
c New Adaptive Ogata 1/{2\pi}\int_0^{\infty} db b J_{\nu}(qT b) func(b)
c----------------------------------------------------------------------
      subroutine adogt(func,qT,Q,nu,z,n,res)
      implicit none
      real*8, intent(in) :: qT,Q,z,n
      integer, intent(in) :: nu
      real*8 h
      real(kind=8), external :: func
      real(kind=8), intent(out) :: res
      real*8, external :: get_ht
      real*8 start,finish,elapsed

c      print *, Q
c      call cpu_time(start)
      h=get_ht(func,nu,int(n),qT,Q)
c      print *, h
c      call cpu_time(finish)
c      elapsed = finish-start
c      print *, 'elasped time 1 is', elapsed/60d0, 'mins'
c      call cpu_time(start)
      if (nu.eq.0) then
        call ogataJ0(func,h,n,qT,z,res)
      else if (nu.eq.1) then
        call ogataJ1(func,h,n,qT,z,res)
      end if
c      call cpu_time(finish)
c      elapsed = finish-start
c      print *, 'elasped time 2 is', elapsed/60d0, 'mins'
      return      

      end

c-----------------------------------------------------------------------
c     Get ht
c-----------------------------------------------------------------------
      real*8 function get_ht(f,nu,n,qT,Q)
      implicit none
      real*8 J0,J0zeros(199),J1zeros(199),Q,dum,ht0,hu,ht,qT
      real*8, external :: solvehu,solvehup,get_hu,f
      integer nu,n,iters
      logical debug
      
      data J0zeros / 2.404825557695773,
     >               5.520078110286311,
     >               8.65372791291101,
     >               11.79153443901428,
     >               14.93091770848779,
     >               18.07106396791092,
     >               21.21163662987926,
     >               24.3524715307493,
     >               27.49347913204025,
     >               30.63460646843198,
     >               33.77582021357357,
     >               36.91709835366404,
     >               40.05842576462824,
     >               43.19979171317673,
     >               46.34118837166182,
     >               49.48260989739781,
     >               52.624051841115,
     >               55.76551075501998,
     >               58.90698392608094,
     >               62.04846919022716,
     >               65.18996480020687,
     >               68.3314693298568,
     >               71.47298160359374,
     >               74.61450064370183,
     >               77.75602563038805,
     >               80.8975558711376,
     >               84.0390907769382,
     >               87.1806298436412,
     >               90.3221726372105,
     >               93.4637187819448,
     >               96.6052679509963,
     >               99.7468198586806,
     >               102.8883742541948,
     >               106.0299309164516,
     >               109.1714896498054,
     >               112.3130502804949,
     >               115.4546126536669,
     >               118.5961766308725,
     >               121.737742087951,
     >               124.879308913233,
     >               128.0208770060083,
     >               131.1624462752139,
     >               134.3040166383055,
     >               137.4455880202843,
     >               140.5871603528543,
     >               143.7287335736897,
     >               146.8703076257966,
     >               150.0118824569548,
     >               153.1534580192279,
     >               156.2950342685335,
     >               159.4366111642632,
     >               162.5781886689467,
     >               165.719766747955,
     >               168.8613453692358,
     >               172.0029245030782,
     >               175.1445041219027,
     >               178.2860842000738,
     >               181.427664713731,
     >               184.5692456406387,
     >               187.7108269600494,
     >               190.8524086525815,
     >               193.9939907001091,
     >               197.1355730856614,
     >               200.2771557933324,
     >               203.4187388081986,
     >               206.5603221162445,
     >               209.7019057042941,
     >               212.8434895599495,
     >               215.985073671534,
     >               219.1266580280406,
     >               222.2682426190843,
     >               225.4098274348594,
     >               228.5514124660988,
     >               231.6929977040386,
     >               234.8345831403832,
     >               237.9761687672757,
     >               241.117754577268,
     >               244.2593405632957,
     >               247.4009267186528,
     >               250.5425130369699,
     >               253.6840995121931,
     >               256.8256861385644,
     >               259.9672729106045,
     >               263.1088598230955,
     >               266.2504468710659,
     >               269.392034049776,
     >               272.5336213547049,
     >               275.6752087815374,
     >               278.8167963261531,
     >               281.9583839846149,
     >               285.0999717531595,
     >               288.2415596281877,
     >               291.3831476062552,
     >               294.524735684065,
     >               297.666323858459,
     >               300.8079121264111,
     >               303.9495004850206,
     >               307.091088931505,
     >               310.232677463195,
     >               313.3742660775279,
     >               316.5158547720429,
     >               319.6574435443762,
     >               322.7990323922556,
     >               325.9406213134967,
     >               329.0822103059985,
     >               332.2237993677396,
     >               335.3653884967741,
     >               338.5069776912284,
     >               341.6485669492981,
     >               344.790156269244,
     >               347.9317456493902,
     >               351.0733350881206,
     >               354.2149245838765,
     >               357.3565141351538,
     >               360.498103740501,
     >               363.639693398517,
     >               366.7812831078483,
     >               369.9228728671875,
     >               373.0644626752713,
     >               376.2060525308784,
     >               379.3476424328285,
     >               382.4892323799793,
     >               385.6308223712264,
     >               388.7724124055006,
     >               391.9140024817674,
     >               395.0555925990249,
     >               398.1971827563028,
     >               401.3387729526615,
     >               404.4803631871904,
     >               407.6219534590068,
     >               410.7635437672553,
     >               413.9051341111063,
     >               417.0467244897553,
     >               420.1883149024217,
     >               423.329905348348,
     >               426.4714958267996,
     >               429.6130863370627,
     >               432.7546768784446,
     >               435.8962674502723,
     >               439.0378580518925,
     >               442.17944868267,
     >               445.3210393419877,
     >               448.462630029246,
     >               451.6042207438617,
     >               454.7458114852677,
     >               457.8874022529128,
     >               461.0289930462605,
     >               464.1705838647888,
     >               467.3121747079899,
     >               470.4537655753699,
     >               473.5953564664472,
     >               476.7369473807533,
     >               479.8785383178322,
     >               483.0201292772397,
     >               486.1617202585427,
     >               489.3033112613194,
     >               492.444902285159,
     >               495.5864933296608,
     >               498.7280843944346,
     >               501.8696754790994,
     >               505.0112665832841,
     >               508.1528577066267,
     >               511.294448848774,
     >               514.4360400093816,
     >               517.5776311881132,
     >               520.719222384641,
     >               523.8608135986445,
     >               527.0024048298116,
     >               530.1439960778367,
     >               533.285587342422,
     >               536.427178623277,
     >               539.5687699201169,
     >               542.7103612326645,
     >               545.8519525606484,
     >               548.9935439038036,
     >               552.1351352618713,
     >               555.2767266345982,
     >               558.4183180217369,
     >               561.5599094230457,
     >               564.701500838288,
     >               567.8430922672325,
     >               570.984683709653,
     >               574.1262751653285,
     >               577.2678666340424,
     >               580.409458115583,
     >               583.5510496097433,
     >               586.6926411163202,
     >               589.8342326351157,
     >               592.9758241659354,
     >               596.1174157085893,
     >               599.2590072628912,
     >               602.4005988286588,
     >               605.5421904057138,
     >               608.6837819938813,
     >               611.8253735929903,
     >               614.9669652028729,
     >               618.108556823365,
     >               621.2501484543054,
     >               624.3917400955367
     >             /
      data J1zeros / 3.831705970207512,
     >               7.0155866698156,
     >               10.17346813506272,
     >               13.32369193631422,
     >               16.47063005087763,
     >               19.61585851046824,
     >               22.76008438059277,
     >               25.90367208761838,
     >               29.04682853491686,
     >               32.18967991097441,
     >               35.33230755008387,
     >               38.47476623477161,
     >               41.61709421281445,
     >               44.75931899765282,
     >               47.90146088718545,
     >               51.04353518357151,
     >               54.18555364106131,
     >               57.32752543790101,
     >               60.46945784534749,
     >               63.61135669848123,
     >               66.75322673409849,
     >               69.89507183749578,
     >               73.03689522557383,
     >               76.17869958464146,
     >               79.3204871754763,
     >               82.4622599143736,
     >               85.6040194363502,
     >               88.7457671449263,
     >               91.887504251695,
     >               95.0292318080447,
     >               98.1709507307908,
     >               101.3126618230387,
     >               104.4543657912828,
     >               107.5960632595092,
     >               110.7377547808992,
     >               113.879440847595,
     >               117.0211218988924,
     >               120.162798328149,
     >               123.3044704886357,
     >               126.4461386985166,
     >               129.587803245104,
     >               132.7294643885096,
     >               135.871122364789,
     >               139.0127773886597,
     >               142.154429655859,
     >               145.2960793451959,
     >               148.4377266203422,
     >               151.5793716314014,
     >               154.7210145162859,
     >               157.8626554019303,
     >               161.004294405362,
     >               164.1459316346496,
     >               167.2875671897441,
     >               170.4292011632266,
     >               173.5708336409759,
     >               176.7124647027638,
     >               179.8540944227884,
     >               182.995722870153,
     >               186.1373501092955,
     >               189.278976200376,
     >               192.4206011996257,
     >               195.5622251596626,
     >               198.703848129777,
     >               201.8454701561909,
     >               204.9870912822923,
     >               208.1287115488501,
     >               211.2703309942078,
     >               214.411949654462,
     >               217.5535675636242,
     >               220.6951847537693,
     >               223.8368012551717,
     >               226.9784170964295,
     >               230.1200323045791,
     >               233.2616469052006,
     >               236.4032609225143,
     >               239.5448743794699,
     >               242.6864872978287,
     >               245.8280996982398,
     >               248.9697116003099,
     >               252.1113230226686,
     >               255.2529339830282,
     >               258.3945444982395,
     >               261.5361545843441,
     >               264.6777642566215,
     >               267.8193735296346,
     >               270.9609824172707,
     >               274.1025909327807,
     >               277.2441990888146,
     >               280.3858068974556,
     >               283.5274143702514,
     >               286.6690215182434,
     >               289.8106283519944,
     >               292.9522348816139,
     >               296.0938411167825,
     >               299.2354470667741,
     >               302.3770527404775,
     >               305.5186581464156,
     >               308.6602632927644,
     >               311.8018681873705,
     >               314.9434728377671,
     >               318.0850772511904,
     >               321.2266814345928,
     >               324.3682853946579,
     >               327.5098891378125,
     >               330.6514926702394,
     >               333.7930959978885,
     >               336.934699126488,
     >               340.0763020615541,
     >               343.2179048084012,
     >               346.359507372151,
     >               349.5011097577409,
     >               352.6427119699324,
     >               355.7843140133188,
     >               358.9259158923327,
     >               362.0675176112526,
     >               365.2091191742101,
     >               368.3507205851957,
     >               371.4923218480648,
     >               374.6339229665437,
     >               377.7755239442347,
     >               380.9171247846209,
     >               384.0587254910721,
     >               387.2003260668483,
     >               390.3419265151044,
     >               393.483526838895,
     >               396.6251270411776,
     >               399.7667271248168,
     >               402.9083270925879,
     >               406.0499269471803,
     >               409.1915266912009,
     >               412.333126327177,
     >               415.4747258575594,
     >               418.6163252847256,
     >               421.7579246109818,
     >               424.8995238385667,
     >               428.0411229696527,
     >               431.1827220063489,
     >               434.3243209507038,
     >               437.4659198047066,
     >               440.6075185702901,
     >               443.7491172493322,
     >               446.890715843658,
     >               450.0323143550416,
     >               453.1739127852082,
     >               456.3155111358349,
     >               459.4571094085536,
     >               462.5987076049514,
     >               465.7403057265727,
     >               468.8819037749206,
     >               472.0235017514582,
     >               475.1650996576098,
     >               478.3066974947622,
     >               481.4482952642662,
     >               484.5898929674376,
     >               487.731490605558,
     >               490.8730881798765,
     >               494.0146856916103,
     >               497.1562831419456,
     >               500.2978805320394,
     >               503.4394778630194,
     >               506.5810751359852,
     >               509.7226723520096,
     >               512.8642695121389,
     >               516.0058666173942,
     >               519.1474636687714,
     >               522.2890606672431,
     >               525.4306576137581,
     >               528.5722545092428,
     >               531.7138513546017,
     >               534.8554481507182,
     >               537.9970448984547,
     >               541.1386415986541,
     >               544.2802382521394,
     >               547.4218348597149,
     >               550.5634314221664,
     >               553.7050279402621,
     >               556.8466244147527,
     >               559.9882208463721,
     >               563.1298172358377,
     >               566.2714135838511,
     >               569.4130098910987,
     >               572.5546061582511,
     >               575.6962023859651,
     >               578.8377985748825,
     >               581.9793947256318,
     >               585.1209908388276,
     >               588.2625869150719,
     >               591.4041829549533,
     >               594.5457789590482,
     >               597.6873749279211,
     >               600.8289708621243,
     >               603.9705667621989,
     >               607.1121626286747,
     >               610.2537584620707,
     >               613.395354262895,
     >               616.5369500316456,
     >               619.6785457688103,
     >               622.8201414748671,
     >               625.9617371502843/
      
      if (nu.eq.0) then
            J0=J0zeros(n)
      elseif (nu.eq.1) then
            J0=J1zeros(n)
      endif
      hu = get_hu(f,qT,Q,nu)
c      print *, hu,qT
      if (hu.gt.3.14d0) then
          hu = 3.14d0
      endif
      ht0=2d0*hu/(J0**2d0)
      dum=1.0d0
      debug=.true.
      call solven(solvehu,solvehup,ht0,hu,n,dum,ht,iters,debug,nu)
      get_ht=ht
      end

c-----------------------------------------------------------------------
c	Additional x dependence
c-----------------------------------------------------------------------
      real*8 function f2xf(f,qT,b)
      implicit none
      real*8 b,qT
      real*8, external :: f
      
      f2xf = b/qT*f(b/qT)

      end

c-----------------------------------------------------------------------
c     Get hu
c-----------------------------------------------------------------------
      real*8 function get_hu(f,qT,Q,nu)
      implicit none
      real*8, external :: f,GOLDEN,f2xf
      real*8 J0,Q,X1,X2,X3,TOL,qT,hu
      integer nu
      
      if (nu.eq.0) then
            J0=2.404825557695773d0
      elseif (nu.eq.1) then
            J0=3.831705970207515d0
      endif
      
      X1=Q/10d0; X2=Q; X3=10d0*Q
      TOL=1.d-2
      hu=GOLDEN(f,f2xf,X1,X2,X3,TOL,qT)/J0
      get_hu = hu
      end
      
c-----------------------------------------------------------------------
c     GOLDEN SEARCH METHOD
c-----------------------------------------------------------------------
      REAL*8 FUNCTION GOLDEN(F,f2xf,AX,BX,CX,TOL,qT)
      implicit none
      REAL*8 AX,BX,CX,TOL,X0,X1,X2,X3,R,C,F0,F1,F2,F3,qT
      real*8, external :: F,f2xf
      
      R=.61803399d0
      C=1d0-R
      X0=AX 
      X3=CX 
      IF(ABS(CX-BX).GT.ABS(BX-AX)) THEN
            X1=BX; X2=BX+C*(CX-BX)
      ELSE
            X2=BX; X1=BX-C*(BX-AX)
      ENDIF
      F1=f2xf(f,qT,X1); F2=f2xf(f,qT,X2)
1     IF(ABS(X3-X0).GT.TOL*(ABS(X1)+ABS(X2))) THEN
            IF(F2.GT.F1) THEN
                  X0=X1; X1=X2
                  X2=R*X1+C*X3
                  F0=F1; F1=F2
                  F2=f2xf(f,qT,X2)
            ELSE
                  X3=X2; X2=X1
                  X1=R*X2+C*X0
                  F3=F2; F2=F1
                  F1=f2xf(f,qT,X1)
            ENDIF
            GOTO 1
      ENDIF
      IF(F1.GT.F2) THEN
            GOLDEN=X1
      ELSE
            GOLDEN=X2
      ENDIF
      RETURN
      END

c-----------------------------------------------------------------------
c     Newton's numerical method
c-----------------------------------------------------------------------      
      subroutine solven(f,fp,ht0,hu,n,dum,ht,iters,debug,nu)
      implicit none
      real(kind=8), intent(in) :: ht0,hu,dum
      integer, intent(in) :: nu,n
      real(kind=8), external :: f,fp
      logical, intent(in) :: debug
      real(kind=8), intent(out) :: ht
      integer, intent(out) :: iters

      real(kind=8) :: deltax, fx, fxprime,tol
      integer :: k,maxiter
          
      maxiter = 20
      tol = 1.d-14
      ht = ht0
      if (debug) then
            endif
      do k=1,maxiter
            fx = f(hu,n,dum,ht,nu)
            fxprime = fp(n,dum,ht,nu)
            ! print *, ht, fx
            if (abs(fx) < tol) then
                  exit
                  endif
            deltax = fx/fxprime
            ht = ht - deltax
            if (ht.LT.0d0) then
                  ht=0d0
            endif

            if (debug) then
            endif
      enddo
      if (k > maxiter) then
            fx = f(hu,n,dum,ht,nu)
            if (abs(fx) > tol) then
            endif
      endif 
      iters = k-1
      end
      
c-----------------------------------------------------------------------
c
c-----------------------------------------------------------------------
      real*8 function solvehu(hu,n,dum,ht,nu)
          implicit none
          real(kind=8), intent(in) :: ht,dum,hu
          integer, intent(in) :: nu,n
          real(kind=8) J0,pi,J0zeros(199),J1zeros(199)
      data J0zeros / 2.404825557695773,
     >               5.520078110286311,
     >               8.65372791291101,
     >               11.79153443901428,
     >               14.93091770848779,
     >               18.07106396791092,
     >               21.21163662987926,
     >               24.3524715307493,
     >               27.49347913204025,
     >               30.63460646843198,
     >               33.77582021357357,
     >               36.91709835366404,
     >               40.05842576462824,
     >               43.19979171317673,
     >               46.34118837166182,
     >               49.48260989739781,
     >               52.624051841115,
     >               55.76551075501998,
     >               58.90698392608094,
     >               62.04846919022716,
     >               65.18996480020687,
     >               68.3314693298568,
     >               71.47298160359374,
     >               74.61450064370183,
     >               77.75602563038805,
     >               80.8975558711376,
     >               84.0390907769382,
     >               87.1806298436412,
     >               90.3221726372105,
     >               93.4637187819448,
     >               96.6052679509963,
     >               99.7468198586806,
     >               102.8883742541948,
     >               106.0299309164516,
     >               109.1714896498054,
     >               112.3130502804949,
     >               115.4546126536669,
     >               118.5961766308725,
     >               121.737742087951,
     >               124.879308913233,
     >               128.0208770060083,
     >               131.1624462752139,
     >               134.3040166383055,
     >               137.4455880202843,
     >               140.5871603528543,
     >               143.7287335736897,
     >               146.8703076257966,
     >               150.0118824569548,
     >               153.1534580192279,
     >               156.2950342685335,
     >               159.4366111642632,
     >               162.5781886689467,
     >               165.719766747955,
     >               168.8613453692358,
     >               172.0029245030782,
     >               175.1445041219027,
     >               178.2860842000738,
     >               181.427664713731,
     >               184.5692456406387,
     >               187.7108269600494,
     >               190.8524086525815,
     >               193.9939907001091,
     >               197.1355730856614,
     >               200.2771557933324,
     >               203.4187388081986,
     >               206.5603221162445,
     >               209.7019057042941,
     >               212.8434895599495,
     >               215.985073671534,
     >               219.1266580280406,
     >               222.2682426190843,
     >               225.4098274348594,
     >               228.5514124660988,
     >               231.6929977040386,
     >               234.8345831403832,
     >               237.9761687672757,
     >               241.117754577268,
     >               244.2593405632957,
     >               247.4009267186528,
     >               250.5425130369699,
     >               253.6840995121931,
     >               256.8256861385644,
     >               259.9672729106045,
     >               263.1088598230955,
     >               266.2504468710659,
     >               269.392034049776,
     >               272.5336213547049,
     >               275.6752087815374,
     >               278.8167963261531,
     >               281.9583839846149,
     >               285.0999717531595,
     >               288.2415596281877,
     >               291.3831476062552,
     >               294.524735684065,
     >               297.666323858459,
     >               300.8079121264111,
     >               303.9495004850206,
     >               307.091088931505,
     >               310.232677463195,
     >               313.3742660775279,
     >               316.5158547720429,
     >               319.6574435443762,
     >               322.7990323922556,
     >               325.9406213134967,
     >               329.0822103059985,
     >               332.2237993677396,
     >               335.3653884967741,
     >               338.5069776912284,
     >               341.6485669492981,
     >               344.790156269244,
     >               347.9317456493902,
     >               351.0733350881206,
     >               354.2149245838765,
     >               357.3565141351538,
     >               360.498103740501,
     >               363.639693398517,
     >               366.7812831078483,
     >               369.9228728671875,
     >               373.0644626752713,
     >               376.2060525308784,
     >               379.3476424328285,
     >               382.4892323799793,
     >               385.6308223712264,
     >               388.7724124055006,
     >               391.9140024817674,
     >               395.0555925990249,
     >               398.1971827563028,
     >               401.3387729526615,
     >               404.4803631871904,
     >               407.6219534590068,
     >               410.7635437672553,
     >               413.9051341111063,
     >               417.0467244897553,
     >               420.1883149024217,
     >               423.329905348348,
     >               426.4714958267996,
     >               429.6130863370627,
     >               432.7546768784446,
     >               435.8962674502723,
     >               439.0378580518925,
     >               442.17944868267,
     >               445.3210393419877,
     >               448.462630029246,
     >               451.6042207438617,
     >               454.7458114852677,
     >               457.8874022529128,
     >               461.0289930462605,
     >               464.1705838647888,
     >               467.3121747079899,
     >               470.4537655753699,
     >               473.5953564664472,
     >               476.7369473807533,
     >               479.8785383178322,
     >               483.0201292772397,
     >               486.1617202585427,
     >               489.3033112613194,
     >               492.444902285159,
     >               495.5864933296608,
     >               498.7280843944346,
     >               501.8696754790994,
     >               505.0112665832841,
     >               508.1528577066267,
     >               511.294448848774,
     >               514.4360400093816,
     >               517.5776311881132,
     >               520.719222384641,
     >               523.8608135986445,
     >               527.0024048298116,
     >               530.1439960778367,
     >               533.285587342422,
     >               536.427178623277,
     >               539.5687699201169,
     >               542.7103612326645,
     >               545.8519525606484,
     >               548.9935439038036,
     >               552.1351352618713,
     >               555.2767266345982,
     >               558.4183180217369,
     >               561.5599094230457,
     >               564.701500838288,
     >               567.8430922672325,
     >               570.984683709653,
     >               574.1262751653285,
     >               577.2678666340424,
     >               580.409458115583,
     >               583.5510496097433,
     >               586.6926411163202,
     >               589.8342326351157,
     >               592.9758241659354,
     >               596.1174157085893,
     >               599.2590072628912,
     >               602.4005988286588,
     >               605.5421904057138,
     >               608.6837819938813,
     >               611.8253735929903,
     >               614.9669652028729,
     >               618.108556823365,
     >               621.2501484543054,
     >               624.3917400955367
     >             /
      data J1zeros / 3.831705970207512,
     >               7.0155866698156,
     >               10.17346813506272,
     >               13.32369193631422,
     >               16.47063005087763,
     >               19.61585851046824,
     >               22.76008438059277,
     >               25.90367208761838,
     >               29.04682853491686,
     >               32.18967991097441,
     >               35.33230755008387,
     >               38.47476623477161,
     >               41.61709421281445,
     >               44.75931899765282,
     >               47.90146088718545,
     >               51.04353518357151,
     >               54.18555364106131,
     >               57.32752543790101,
     >               60.46945784534749,
     >               63.61135669848123,
     >               66.75322673409849,
     >               69.89507183749578,
     >               73.03689522557383,
     >               76.17869958464146,
     >               79.3204871754763,
     >               82.4622599143736,
     >               85.6040194363502,
     >               88.7457671449263,
     >               91.887504251695,
     >               95.0292318080447,
     >               98.1709507307908,
     >               101.3126618230387,
     >               104.4543657912828,
     >               107.5960632595092,
     >               110.7377547808992,
     >               113.879440847595,
     >               117.0211218988924,
     >               120.162798328149,
     >               123.3044704886357,
     >               126.4461386985166,
     >               129.587803245104,
     >               132.7294643885096,
     >               135.871122364789,
     >               139.0127773886597,
     >               142.154429655859,
     >               145.2960793451959,
     >               148.4377266203422,
     >               151.5793716314014,
     >               154.7210145162859,
     >               157.8626554019303,
     >               161.004294405362,
     >               164.1459316346496,
     >               167.2875671897441,
     >               170.4292011632266,
     >               173.5708336409759,
     >               176.7124647027638,
     >               179.8540944227884,
     >               182.995722870153,
     >               186.1373501092955,
     >               189.278976200376,
     >               192.4206011996257,
     >               195.5622251596626,
     >               198.703848129777,
     >               201.8454701561909,
     >               204.9870912822923,
     >               208.1287115488501,
     >               211.2703309942078,
     >               214.411949654462,
     >               217.5535675636242,
     >               220.6951847537693,
     >               223.8368012551717,
     >               226.9784170964295,
     >               230.1200323045791,
     >               233.2616469052006,
     >               236.4032609225143,
     >               239.5448743794699,
     >               242.6864872978287,
     >               245.8280996982398,
     >               248.9697116003099,
     >               252.1113230226686,
     >               255.2529339830282,
     >               258.3945444982395,
     >               261.5361545843441,
     >               264.6777642566215,
     >               267.8193735296346,
     >               270.9609824172707,
     >               274.1025909327807,
     >               277.2441990888146,
     >               280.3858068974556,
     >               283.5274143702514,
     >               286.6690215182434,
     >               289.8106283519944,
     >               292.9522348816139,
     >               296.0938411167825,
     >               299.2354470667741,
     >               302.3770527404775,
     >               305.5186581464156,
     >               308.6602632927644,
     >               311.8018681873705,
     >               314.9434728377671,
     >               318.0850772511904,
     >               321.2266814345928,
     >               324.3682853946579,
     >               327.5098891378125,
     >               330.6514926702394,
     >               333.7930959978885,
     >               336.934699126488,
     >               340.0763020615541,
     >               343.2179048084012,
     >               346.359507372151,
     >               349.5011097577409,
     >               352.6427119699324,
     >               355.7843140133188,
     >               358.9259158923327,
     >               362.0675176112526,
     >               365.2091191742101,
     >               368.3507205851957,
     >               371.4923218480648,
     >               374.6339229665437,
     >               377.7755239442347,
     >               380.9171247846209,
     >               384.0587254910721,
     >               387.2003260668483,
     >               390.3419265151044,
     >               393.483526838895,
     >               396.6251270411776,
     >               399.7667271248168,
     >               402.9083270925879,
     >               406.0499269471803,
     >               409.1915266912009,
     >               412.333126327177,
     >               415.4747258575594,
     >               418.6163252847256,
     >               421.7579246109818,
     >               424.8995238385667,
     >               428.0411229696527,
     >               431.1827220063489,
     >               434.3243209507038,
     >               437.4659198047066,
     >               440.6075185702901,
     >               443.7491172493322,
     >               446.890715843658,
     >               450.0323143550416,
     >               453.1739127852082,
     >               456.3155111358349,
     >               459.4571094085536,
     >               462.5987076049514,
     >               465.7403057265727,
     >               468.8819037749206,
     >               472.0235017514582,
     >               475.1650996576098,
     >               478.3066974947622,
     >               481.4482952642662,
     >               484.5898929674376,
     >               487.731490605558,
     >               490.8730881798765,
     >               494.0146856916103,
     >               497.1562831419456,
     >               500.2978805320394,
     >               503.4394778630194,
     >               506.5810751359852,
     >               509.7226723520096,
     >               512.8642695121389,
     >               516.0058666173942,
     >               519.1474636687714,
     >               522.2890606672431,
     >               525.4306576137581,
     >               528.5722545092428,
     >               531.7138513546017,
     >               534.8554481507182,
     >               537.9970448984547,
     >               541.1386415986541,
     >               544.2802382521394,
     >               547.4218348597149,
     >               550.5634314221664,
     >               553.7050279402621,
     >               556.8466244147527,
     >               559.9882208463721,
     >               563.1298172358377,
     >               566.2714135838511,
     >               569.4130098910987,
     >               572.5546061582511,
     >               575.6962023859651,
     >               578.8377985748825,
     >               581.9793947256318,
     >               585.1209908388276,
     >               588.2625869150719,
     >               591.4041829549533,
     >               594.5457789590482,
     >               597.6873749279211,
     >               600.8289708621243,
     >               603.9705667621989,
     >               607.1121626286747,
     >               610.2537584620707,
     >               613.395354262895,
     >               616.5369500316456,
     >               619.6785457688103,
     >               622.8201414748671,
     >               625.9617371502843/
          
      !dum is dummy variable used to hold place
          
          if (nu .eq. 0) then
             J0 = J0zeros(n)
          else if (nu .eq. 1) then
             J0 = J1zeros(n)
          end if
          pi = 3.141592653589793d0
          solvehu= hu/pi-dtanh(pi/2d0*dsinh(ht*J0/pi))
  
      end

      real*8 function solvehup(n,dum,ht,nu)
          implicit none
          real(kind=8), intent(in) :: ht,dum
          integer, intent(in) :: nu,n
          real(kind=8) J0,pi,J0zeros(199),J1zeros(199)
      data J0zeros / 2.404825557695773,
     >               5.520078110286311,
     >               8.65372791291101,
     >               11.79153443901428,
     >               14.93091770848779,
     >               18.07106396791092,
     >               21.21163662987926,
     >               24.3524715307493,
     >               27.49347913204025,
     >               30.63460646843198,
     >               33.77582021357357,
     >               36.91709835366404,
     >               40.05842576462824,
     >               43.19979171317673,
     >               46.34118837166182,
     >               49.48260989739781,
     >               52.624051841115,
     >               55.76551075501998,
     >               58.90698392608094,
     >               62.04846919022716,
     >               65.18996480020687,
     >               68.3314693298568,
     >               71.47298160359374,
     >               74.61450064370183,
     >               77.75602563038805,
     >               80.8975558711376,
     >               84.0390907769382,
     >               87.1806298436412,
     >               90.3221726372105,
     >               93.4637187819448,
     >               96.6052679509963,
     >               99.7468198586806,
     >               102.8883742541948,
     >               106.0299309164516,
     >               109.1714896498054,
     >               112.3130502804949,
     >               115.4546126536669,
     >               118.5961766308725,
     >               121.737742087951,
     >               124.879308913233,
     >               128.0208770060083,
     >               131.1624462752139,
     >               134.3040166383055,
     >               137.4455880202843,
     >               140.5871603528543,
     >               143.7287335736897,
     >               146.8703076257966,
     >               150.0118824569548,
     >               153.1534580192279,
     >               156.2950342685335,
     >               159.4366111642632,
     >               162.5781886689467,
     >               165.719766747955,
     >               168.8613453692358,
     >               172.0029245030782,
     >               175.1445041219027,
     >               178.2860842000738,
     >               181.427664713731,
     >               184.5692456406387,
     >               187.7108269600494,
     >               190.8524086525815,
     >               193.9939907001091,
     >               197.1355730856614,
     >               200.2771557933324,
     >               203.4187388081986,
     >               206.5603221162445,
     >               209.7019057042941,
     >               212.8434895599495,
     >               215.985073671534,
     >               219.1266580280406,
     >               222.2682426190843,
     >               225.4098274348594,
     >               228.5514124660988,
     >               231.6929977040386,
     >               234.8345831403832,
     >               237.9761687672757,
     >               241.117754577268,
     >               244.2593405632957,
     >               247.4009267186528,
     >               250.5425130369699,
     >               253.6840995121931,
     >               256.8256861385644,
     >               259.9672729106045,
     >               263.1088598230955,
     >               266.2504468710659,
     >               269.392034049776,
     >               272.5336213547049,
     >               275.6752087815374,
     >               278.8167963261531,
     >               281.9583839846149,
     >               285.0999717531595,
     >               288.2415596281877,
     >               291.3831476062552,
     >               294.524735684065,
     >               297.666323858459,
     >               300.8079121264111,
     >               303.9495004850206,
     >               307.091088931505,
     >               310.232677463195,
     >               313.3742660775279,
     >               316.5158547720429,
     >               319.6574435443762,
     >               322.7990323922556,
     >               325.9406213134967,
     >               329.0822103059985,
     >               332.2237993677396,
     >               335.3653884967741,
     >               338.5069776912284,
     >               341.6485669492981,
     >               344.790156269244,
     >               347.9317456493902,
     >               351.0733350881206,
     >               354.2149245838765,
     >               357.3565141351538,
     >               360.498103740501,
     >               363.639693398517,
     >               366.7812831078483,
     >               369.9228728671875,
     >               373.0644626752713,
     >               376.2060525308784,
     >               379.3476424328285,
     >               382.4892323799793,
     >               385.6308223712264,
     >               388.7724124055006,
     >               391.9140024817674,
     >               395.0555925990249,
     >               398.1971827563028,
     >               401.3387729526615,
     >               404.4803631871904,
     >               407.6219534590068,
     >               410.7635437672553,
     >               413.9051341111063,
     >               417.0467244897553,
     >               420.1883149024217,
     >               423.329905348348,
     >               426.4714958267996,
     >               429.6130863370627,
     >               432.7546768784446,
     >               435.8962674502723,
     >               439.0378580518925,
     >               442.17944868267,
     >               445.3210393419877,
     >               448.462630029246,
     >               451.6042207438617,
     >               454.7458114852677,
     >               457.8874022529128,
     >               461.0289930462605,
     >               464.1705838647888,
     >               467.3121747079899,
     >               470.4537655753699,
     >               473.5953564664472,
     >               476.7369473807533,
     >               479.8785383178322,
     >               483.0201292772397,
     >               486.1617202585427,
     >               489.3033112613194,
     >               492.444902285159,
     >               495.5864933296608,
     >               498.7280843944346,
     >               501.8696754790994,
     >               505.0112665832841,
     >               508.1528577066267,
     >               511.294448848774,
     >               514.4360400093816,
     >               517.5776311881132,
     >               520.719222384641,
     >               523.8608135986445,
     >               527.0024048298116,
     >               530.1439960778367,
     >               533.285587342422,
     >               536.427178623277,
     >               539.5687699201169,
     >               542.7103612326645,
     >               545.8519525606484,
     >               548.9935439038036,
     >               552.1351352618713,
     >               555.2767266345982,
     >               558.4183180217369,
     >               561.5599094230457,
     >               564.701500838288,
     >               567.8430922672325,
     >               570.984683709653,
     >               574.1262751653285,
     >               577.2678666340424,
     >               580.409458115583,
     >               583.5510496097433,
     >               586.6926411163202,
     >               589.8342326351157,
     >               592.9758241659354,
     >               596.1174157085893,
     >               599.2590072628912,
     >               602.4005988286588,
     >               605.5421904057138,
     >               608.6837819938813,
     >               611.8253735929903,
     >               614.9669652028729,
     >               618.108556823365,
     >               621.2501484543054,
     >               624.3917400955367
     >             /
      data J1zeros / 3.831705970207512,
     >               7.0155866698156,
     >               10.17346813506272,
     >               13.32369193631422,
     >               16.47063005087763,
     >               19.61585851046824,
     >               22.76008438059277,
     >               25.90367208761838,
     >               29.04682853491686,
     >               32.18967991097441,
     >               35.33230755008387,
     >               38.47476623477161,
     >               41.61709421281445,
     >               44.75931899765282,
     >               47.90146088718545,
     >               51.04353518357151,
     >               54.18555364106131,
     >               57.32752543790101,
     >               60.46945784534749,
     >               63.61135669848123,
     >               66.75322673409849,
     >               69.89507183749578,
     >               73.03689522557383,
     >               76.17869958464146,
     >               79.3204871754763,
     >               82.4622599143736,
     >               85.6040194363502,
     >               88.7457671449263,
     >               91.887504251695,
     >               95.0292318080447,
     >               98.1709507307908,
     >               101.3126618230387,
     >               104.4543657912828,
     >               107.5960632595092,
     >               110.7377547808992,
     >               113.879440847595,
     >               117.0211218988924,
     >               120.162798328149,
     >               123.3044704886357,
     >               126.4461386985166,
     >               129.587803245104,
     >               132.7294643885096,
     >               135.871122364789,
     >               139.0127773886597,
     >               142.154429655859,
     >               145.2960793451959,
     >               148.4377266203422,
     >               151.5793716314014,
     >               154.7210145162859,
     >               157.8626554019303,
     >               161.004294405362,
     >               164.1459316346496,
     >               167.2875671897441,
     >               170.4292011632266,
     >               173.5708336409759,
     >               176.7124647027638,
     >               179.8540944227884,
     >               182.995722870153,
     >               186.1373501092955,
     >               189.278976200376,
     >               192.4206011996257,
     >               195.5622251596626,
     >               198.703848129777,
     >               201.8454701561909,
     >               204.9870912822923,
     >               208.1287115488501,
     >               211.2703309942078,
     >               214.411949654462,
     >               217.5535675636242,
     >               220.6951847537693,
     >               223.8368012551717,
     >               226.9784170964295,
     >               230.1200323045791,
     >               233.2616469052006,
     >               236.4032609225143,
     >               239.5448743794699,
     >               242.6864872978287,
     >               245.8280996982398,
     >               248.9697116003099,
     >               252.1113230226686,
     >               255.2529339830282,
     >               258.3945444982395,
     >               261.5361545843441,
     >               264.6777642566215,
     >               267.8193735296346,
     >               270.9609824172707,
     >               274.1025909327807,
     >               277.2441990888146,
     >               280.3858068974556,
     >               283.5274143702514,
     >               286.6690215182434,
     >               289.8106283519944,
     >               292.9522348816139,
     >               296.0938411167825,
     >               299.2354470667741,
     >               302.3770527404775,
     >               305.5186581464156,
     >               308.6602632927644,
     >               311.8018681873705,
     >               314.9434728377671,
     >               318.0850772511904,
     >               321.2266814345928,
     >               324.3682853946579,
     >               327.5098891378125,
     >               330.6514926702394,
     >               333.7930959978885,
     >               336.934699126488,
     >               340.0763020615541,
     >               343.2179048084012,
     >               346.359507372151,
     >               349.5011097577409,
     >               352.6427119699324,
     >               355.7843140133188,
     >               358.9259158923327,
     >               362.0675176112526,
     >               365.2091191742101,
     >               368.3507205851957,
     >               371.4923218480648,
     >               374.6339229665437,
     >               377.7755239442347,
     >               380.9171247846209,
     >               384.0587254910721,
     >               387.2003260668483,
     >               390.3419265151044,
     >               393.483526838895,
     >               396.6251270411776,
     >               399.7667271248168,
     >               402.9083270925879,
     >               406.0499269471803,
     >               409.1915266912009,
     >               412.333126327177,
     >               415.4747258575594,
     >               418.6163252847256,
     >               421.7579246109818,
     >               424.8995238385667,
     >               428.0411229696527,
     >               431.1827220063489,
     >               434.3243209507038,
     >               437.4659198047066,
     >               440.6075185702901,
     >               443.7491172493322,
     >               446.890715843658,
     >               450.0323143550416,
     >               453.1739127852082,
     >               456.3155111358349,
     >               459.4571094085536,
     >               462.5987076049514,
     >               465.7403057265727,
     >               468.8819037749206,
     >               472.0235017514582,
     >               475.1650996576098,
     >               478.3066974947622,
     >               481.4482952642662,
     >               484.5898929674376,
     >               487.731490605558,
     >               490.8730881798765,
     >               494.0146856916103,
     >               497.1562831419456,
     >               500.2978805320394,
     >               503.4394778630194,
     >               506.5810751359852,
     >               509.7226723520096,
     >               512.8642695121389,
     >               516.0058666173942,
     >               519.1474636687714,
     >               522.2890606672431,
     >               525.4306576137581,
     >               528.5722545092428,
     >               531.7138513546017,
     >               534.8554481507182,
     >               537.9970448984547,
     >               541.1386415986541,
     >               544.2802382521394,
     >               547.4218348597149,
     >               550.5634314221664,
     >               553.7050279402621,
     >               556.8466244147527,
     >               559.9882208463721,
     >               563.1298172358377,
     >               566.2714135838511,
     >               569.4130098910987,
     >               572.5546061582511,
     >               575.6962023859651,
     >               578.8377985748825,
     >               581.9793947256318,
     >               585.1209908388276,
     >               588.2625869150719,
     >               591.4041829549533,
     >               594.5457789590482,
     >               597.6873749279211,
     >               600.8289708621243,
     >               603.9705667621989,
     >               607.1121626286747,
     >               610.2537584620707,
     >               613.395354262895,
     >               616.5369500316456,
     >               619.6785457688103,
     >               622.8201414748671,
     >               625.9617371502843/
      
      !dum is dummy variable used to hold place
        
          if (nu .eq. 0) then
             J0 = J0zeros(n)
          else if (nu .eq. 1) then
             J0 = J1zeros(n)
          end if
          pi = 3.141592653589793d0
        
          solvehup = -J0/2d0*dcosh(ht*J0/pi)*
     >    (dcosh(pi/2d0*dsinh(ht*J0/pi)))**(-2d0)

      end






